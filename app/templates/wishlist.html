{% extends 'base.html' %}
{% block title %}My Wishlist - Wishlist App{% endblock %}
{% block content %}
<div class="row">
    <div class="col s12">
        <h4>My Wishlist</h4>
        <a class="btn modal-trigger teal" href="#add-item-modal"><i class="material-icons left">add</i>Add Item</a>
        <ul class="collection" id="wishlist-items">
            <!-- Wishlist items will be loaded here by JS -->
        </ul>
    </div>
</div>

<!-- Add/Edit Item Modal -->
<div id="add-item-modal" class="modal">
    <div class="modal-content">
        <h5 id="modal-title">Add Item</h5>
        <form id="item-form">
            <input type="hidden" id="item-id">
            <div class="input-field">
                <input id="item-name" name="name" type="text" required>
                <label for="item-name">Name</label>
            </div>
            <div class="input-field">
                <input id="item-price" name="price" type="number" step="0.01">
                <label for="item-price">Price</label>
            </div>
            <div class="input-field">
                <input id="item-event" name="event" type="text">
                <label for="item-event">Event</label>
            </div>
            <div class="input-field">
                <input id="item-link" name="link" type="url">
                <label for="item-link">Link (URL)</label>
            </div>
            <div class="input-field">
                <textarea id="item-details" name="details" class="materialize-textarea"></textarea>
                <label for="item-details">Details</label>
            </div>
            <!-- Picture upload removed -->
            <button class="btn teal" type="submit">Save</button>
        </form>
    </div>
</div>
{% endblock %}
{% block scripts %}
<script>
// Initialize Materialize components
M.AutoInit();

function loadWishlist() {
    fetch('/wishlist/')
        .then(res => res.json())
        .then(items => {
            const list = document.getElementById('wishlist-items');
            list.innerHTML = '';
            items.forEach(item => {
                const li = document.createElement('li');
                li.className = 'collection-item avatar';
                li.innerHTML = `
                    <img src="/static/default_bullet.png" alt="â€¢" class="circle">
                    <span class="title"><b>${item.name}</b></span>
                    <p>Price: $${item.price || '-'}<br>Event: ${item.event || '-'}<br>${item.details || ''}</p>
                    <a href="${item.link || '#'}" target="_blank">${item.link ? 'Link' : ''}</a>
                    <a href="#!" class="secondary-content" onclick="editItem(${item.id})"><i class="material-icons">edit</i></a>
                    <a href="#!" class="secondary-content" style="margin-right: 2.5rem;" onclick="deleteItem(${item.id})"><i class="material-icons red-text">delete</i></a>
                `;
                list.appendChild(li);
            });
        });
}

function editItem(id) {
    fetch(`/wishlist/` + id)
        .then(res => res.json())
        .then(item => {
            document.getElementById('modal-title').textContent = 'Edit Item';
            document.getElementById('item-id').value = item.id;
            document.getElementById('item-name').value = item.name;
            document.getElementById('item-price').value = item.price;
            document.getElementById('item-event').value = item.event;
            document.getElementById('item-link').value = item.link;
            document.getElementById('item-details').value = item.details;
            M.updateTextFields();
            const modal = M.Modal.getInstance(document.getElementById('add-item-modal'));
            modal.open();
        });
}

function deleteItem(id) {
    if (confirm('Delete this item?')) {
        fetch(`/wishlist/${id}`, { method: 'DELETE' })
            .then(res => res.json())
            .then(() => loadWishlist());
    }
}

document.getElementById('item-form').onsubmit = function(e) {
    e.preventDefault();
    const id = document.getElementById('item-id').value;
    const formData = new FormData(this);
    let method = id ? 'PUT' : 'POST';
    let url = '/wishlist/' + (id ? id : '');
    fetch(url, {
        method: method,
        body: JSON.stringify(Object.fromEntries(formData)),
        headers: { 'Content-Type': 'application/json' }
    })
    .then(res => res.json())
    .then(() => {
        loadWishlist();
        const modal = M.Modal.getInstance(document.getElementById('add-item-modal'));
        modal.close();
        this.reset();
    });
};

document.addEventListener('DOMContentLoaded', function() {
    loadWishlist();
});
</script>
{% endblock %}
