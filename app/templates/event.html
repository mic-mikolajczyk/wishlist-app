{% extends 'base.html' %}
{% block title %}{{ _('Event') }} - {{ event.name }}{% endblock %}
{% block content %}
<div class="row">
  <div class="col s12">
    <div id="event-root" data-event-id="{{ event.id }}" style="display:none;"></div>
  <h4>{{ event.name }} {% if event.archived %}<span class="new badge grey" data-badge-caption="{{ _('Archived') }}"></span>{% endif %}</h4>
    <p>
  {% if event.date %}<b>{{ _('Date') }}:</b> {{ event.date }} |{% endif %}
  {% if event.budget_amount %}<b>{{ _('Budget') }}:</b> {{ event.budget_amount }} {{ event.budget_currency }}{% endif %}
    </p>
    {% set is_admin = (event.admin_user_id == current_user.id) %}
    <div class="event-actions">
      {% if is_admin %}
        {% if event.archived %}
          <form method="post" action="{{ url_for('events.unarchive_event', event_id=event.id) }}" data-confirm="{{ _('Unarchive this event?') }}">
            <button type="submit" class="btn green"><i class="material-icons left">unarchive</i>{{ _('Unarchive Event') }}</button>
          </form>
          <form method="post" action="{{ url_for('events.delete_event', event_id=event.id) }}" data-confirm="{{ _('Delete this event permanently? This cannot be undone.') }}" style="margin-top:0.5rem;">
            <button type="submit" class="btn red"><i class="material-icons left">delete_forever</i>{{ _('Delete Event Permanently') }}</button>
          </form>
        {% else %}
          <a class="btn modal-trigger" href="#edit-event-modal"><i class="material-icons left">edit</i>{{ _('Edit Event') }}</a>
          <form method="post" action="{{ url_for('events.enable_drawing', event_id=event.id) }}" data-confirm="{{ _('Enable drawing? This will lock invitations.') }}">
            <button type="submit" class="btn {% if event.drawing_enabled %}grey disabled{% else %}purple{% endif %}"><i class="material-icons left">shuffle</i>{% if event.drawing_enabled %}{{ _('Drawing Enabled') }}{% else %}{{ _('Enable Drawing') }}{% endif %}</button>
          </form>
          {% if event.drawing_enabled %}
          <form method="post" action="{{ url_for('events.reset_drawing', event_id=event.id) }}" data-confirm="{{ _('Reset all drawing assignments?') }}">
            <button type="submit" class="btn orange"><i class="material-icons left">restart_alt</i>{{ _('Reset Drawing') }}</button>
          </form>
          {% endif %}
          <form method="post" action="{{ url_for('events.archive_event', event_id=event.id) }}" data-confirm="{{ _('Archive this event? Drawing & edits will be disabled.') }}">
            <button type="submit" class="btn grey"><i class="material-icons left">archive</i>{{ _('Archive Event') }}</button>
          </form>
        {% endif %}
      {% else %}
        {% if not event.archived %}
  <form method="post" action="{{ url_for('events.leave_event', event_id=event.id) }}" data-confirm="{{ _('Leave this event?') }}">
          <button type="submit" class="btn orange"><i class="material-icons left">exit_to_app</i>{{ _('Leave Event') }}</button>
        </form>
        {% endif %}
      {% endif %}
    </div>
  </div>
</div>

<div class="row">
  <div class="col s12" style="text-align:center; margin-top:1rem;">
    {% set my_part = None %}
    {% for p in participants %}
      {% if p.user_id == current_user.id %}{% set my_part = p %}{% endif %}
    {% endfor %}
    {% if event.archived %}
      <button class="btn-large grey" style="min-width:260px;" disabled title="{{ _('Event archived') }}">
        <i class="material-icons left">archive</i>{{ _('Event Archived') }}
      </button>
    {% elif event.drawing_enabled %}
      {% if user_has_drawn and recipient_nickname %}
      <div class="card-panel green lighten-5" id="draw-result">
        <h5 style="margin:0;">{{ _('You will give a gift to:') }}</h5>
        <h4 style="margin:0;" id="recipient-name">{{ recipient_nickname }}</h4>
      </div>
      {% else %}
      <button id="draw-button" class="btn-large purple" style="min-width:260px;">
        <span id="draw-btn-label"><i class="material-icons left">card_giftcard</i>{{ _('Draw Your Recipient') }}</span>
      </button>
      {% endif %}
    {% else %}
      <button class="btn-large grey" style="min-width:260px;" disabled title="{{ _('Drawing not enabled yet') }}">
        <i class="material-icons left">lock</i>{{ _('Drawing not available') }}
      </button>
    {% endif %}
  </div>
</div>

<div class="row">
  <div class="col s12 m6">
  <h5>{{ _('Participants') }}</h5>
    <ul class="collection" id="participants-list">
      {% for p in participants %}
        {% if is_admin and not event.drawing_enabled and not event.archived and not p.is_admin %}
  <form method="post" action="{{ url_for('events.remove_participant', event_id=event.id, participant_id=p.id) }}" style="display:inline; float:right; margin-left:0.75rem;" data-confirm="{{ _('Remove this participant from the event?') }}">
          <button type="submit" class="btn-small btn-flat"><i class="material-icons" style="font-size:16px;">close</i></button>
        </form>
        {% endif %}
      <li class="collection-item participant-row {% if p.status == 'accepted' %}clickable{% endif %}" data-user-id="{{ p.user.id }}" data-nickname="{{ p.user.nickname }}" {% if p.status == 'accepted' %}style="cursor:pointer;"{% endif %}>
        <span class="title"><b>{{ p.user.nickname }}</b></span>
        {% if p.status == 'pending' %}<span class="new badge orange" data-badge-caption="{{ _('Pending') }}"></span>{% endif %}
        {% if p.is_admin %}<span class="new badge teal" data-badge-caption="{{ _('Admin') }}"></span>{% endif %}
        {% if event.drawing_enabled and p.user_id == (my_part.recipient.user_id if my_part and my_part.recipient else None) %}
          <span class="badge purple" data-badge-caption="{{ _('Your Recipient') }}"></span>
        {% endif %}
      </li>
      {% endfor %}
    </ul>
  {% if is_admin and not event.drawing_enabled and not event.archived %}
  <a class="btn teal" href="{{ url_for('events.invite_page', event_id=event.id) }}"><i class="material-icons left">group_add</i>{{ _('Invite Participants') }}</a>
    {% endif %}
  </div>

  <div class="col s12 m6">
  <h5 id="participant-wishlist-title">{{ _('Participant Wishlist') }}</h5>
    <ul class="collection" id="participant-wishlist"></ul>
  </div>
</div>

<!-- Edit Event Modal -->
<div id="edit-event-modal" class="modal">
  <div class="modal-content">
  <h5>{{ _('Edit Event') }}</h5>
    <form method="post" action="{{ url_for('events.edit_event', event_id=event.id) }}">
      <div class="input-field">
        <input name="name" id="edit-event-name" type="text" value="{{ event.name }}" required>
  <label for="edit-event-name" class="active">{{ _('Event Name') }}</label>
      </div>
      <div class="input-field">
        <input name="date" id="edit-event-date" type="date" value="{{ event.date }}">
  <label for="edit-event-date" class="active">{{ _('Date') }}</label>
      </div>
      <div class="input-field">
        <input name="budget_amount" id="edit-event-budget" type="number" step="0.01" value="{{ event.budget_amount }}">
  <label for="edit-event-budget" class="active">{{ _('Budget Amount') }}</label>
      </div>
      <div class="input-field">
        <select name="budget_currency" id="edit-event-currency">
          <option value="PLN" {% if event.budget_currency=='PLN' %}selected{% endif %}>PLN</option>
          <option value="EUR" {% if event.budget_currency=='EUR' %}selected{% endif %}>EUR</option>
          <option value="USD" {% if event.budget_currency=='USD' %}selected{% endif %}>USD</option>
        </select>
  <label for="edit-event-currency">{{ _('Currency') }}</label>
      </div>
  <button type="submit" class="btn teal">{{ _('Save') }}</button>
    </form>
  </div>
</div>
{% endblock %}
{% block scripts %}
<script>
M.AutoInit();
const EVENT_ID = parseInt(document.getElementById('event-root').getAttribute('data-event-id'), 10);
// Localized UI text constants
const TXT_GIFT_TO = "{{ _('You will give a gift to:') }}";
const TXT_PRICE = "{{ _('Price') }}";
const TXT_EVENT = "{{ _('Event') }}";
const TXT_LINK = "{{ _('Link') }}";
const TXT_DRAW_FAILED = "{{ _('Draw failed') }}";
const TXT_S_WISHLIST = "{{ _('\'s Wishlist') }}";
const TXT_DRAW_YOUR_RECIPIENT = "{{ _('Draw Your Recipient') }}";
const TXT_DRAWING = "{{ _('Drawing...') }}";

function loadParticipantWishlist(eventId, userId, nickname) {
  fetch(`/events/${eventId}/participant/${userId}/wishlist`)
    .then(res => res.json())
    .then(items => {
  document.getElementById('participant-wishlist-title').textContent = nickname + " " + TXT_S_WISHLIST;
      const list = document.getElementById('participant-wishlist');
      list.innerHTML='';
      items.forEach(item => {
        const li=document.createElement('li');
        li.className='collection-item avatar';
  li.innerHTML=`<img src="/static/default_bullet.png" class="circle">\n          <span class="title"><b>${item.name}</b></span>\n          <p>${TXT_PRICE}: ${item.price || '-'} | ${TXT_EVENT}: ${item.event || '-'}<br>${item.details || ''}</p>\n          <a href="${item.link || '#'}" target="_blank">${item.link? TXT_LINK : ''}</a>`;
        list.appendChild(li);
      });
    });
}

document.addEventListener('DOMContentLoaded', function() {
  // Attach confirm handlers for forms declaring data-confirm
  document.querySelectorAll('form[data-confirm]').forEach(function(f){
    f.addEventListener('submit', function(e){
      const msg = f.getAttribute('data-confirm');
      if(!confirm(msg)) { e.preventDefault(); }
    });
  });
  document.querySelectorAll('.participant-row.clickable').forEach(function(row){
    row.addEventListener('click', function(){
      const userId=this.getAttribute('data-user-id');
      const nickname=this.getAttribute('data-nickname');
      loadParticipantWishlist(EVENT_ID, userId, nickname);
    });
  });
  const drawBtn = document.getElementById('draw-button');
  if (drawBtn) {
    drawBtn.addEventListener('click', function(){
      // Replace button with progress bar wrapper
      const wrapper = document.createElement('div');
      wrapper.id='draw-progress-wrapper';
      wrapper.style.minWidth='260px';
      wrapper.style.display='inline-block';
      wrapper.innerHTML = `\n        <div class="draw-progress-shell" style="position:relative;height:48px;border-radius:4px;overflow:hidden;background:#6a1b9a;">\n          <div id="draw-bar" style="background:#9c27b0;height:100%;width:0%;transition:width 0.15s linear;"></div>\n          <div class="progress-label" style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-weight:500;color:#fff;">${TXT_DRAWING}</div>\n        </div>`;
      drawBtn.parentNode.replaceChild(wrapper, drawBtn);
      let progress = 0;
      let resultData = null;
      let finished = false;
      const interval = setInterval(()=>{
        progress += 100/30; // ~3s total
        if (progress > 100) progress = 100;
        const bar = document.getElementById('draw-bar');
        if (bar) bar.style.width = progress + '%';
        if (progress >= 100 && !finished){
          finished = true;
          clearInterval(interval);
          if (resultData && resultData.recipient_nickname){
            const panel = document.createElement('div');
            panel.className='card-panel green lighten-5';
            panel.id='draw-result';
            panel.innerHTML=`<h5 style='margin:0;'>${TXT_GIFT_TO}</h5><h4 style='margin:0;' id='recipient-name'>${resultData.recipient_nickname}</h4>`;
            wrapper.parentNode.replaceChild(panel, wrapper);
            document.querySelectorAll('#participants-list li').forEach(function(li){
              if(li.getAttribute('data-nickname') === resultData.recipient_nickname){
                li.classList.add('purple','lighten-5');
              }
            });
          } else {
            // Unexpected missing data
            M.toast({html: TXT_DRAW_FAILED});
            const restoredBtn = document.createElement('button');
            restoredBtn.id='draw-button';
            restoredBtn.className='btn-large purple';
            restoredBtn.style.minWidth='260px';
            restoredBtn.innerHTML = `<span id="draw-btn-label"><i class="material-icons left">card_giftcard</i>${TXT_DRAW_YOUR_RECIPIENT}</span>`;
            wrapper.parentNode.replaceChild(restoredBtn, wrapper);
          }
        }
      }, 100);
      fetch(`/events/${EVENT_ID}/drawing/draw`, {method:'POST'})
        .then(r=>r.json())
        .then(data=>{
          if(data.error){
            if (data.recipient_nickname){
              resultData = { recipient_nickname: data.recipient_nickname };
              // accelerate to completion if already drawn
              progress = 100;
            } else {
              M.toast({html: data.error});
              clearInterval(interval);
              // Restore button
              const restoredBtn = document.createElement('button');
              restoredBtn.id='draw-button';
              restoredBtn.className='btn-large purple';
              restoredBtn.style.minWidth='260px';
              restoredBtn.innerHTML = `<span id="draw-btn-label"><i class="material-icons left">card_giftcard</i>${TXT_DRAW_YOUR_RECIPIENT}</span>`;
              wrapper.parentNode.replaceChild(restoredBtn, wrapper);
              // Re-bind handler
              restoredBtn.addEventListener('click', arguments.callee);
            }
            return;
          }
          resultData = data; // will be shown when progress completes
        })
        .catch(err=>{
          M.toast({html: TXT_DRAW_FAILED});
          clearInterval(interval);
          const restoredBtn = document.createElement('button');
          restoredBtn.id='draw-button';
          restoredBtn.className='btn-large purple';
          restoredBtn.style.minWidth='260px';
          restoredBtn.innerHTML = `<span id="draw-btn-label"><i class="material-icons left">card_giftcard</i>${TXT_DRAW_YOUR_RECIPIENT}</span>`;
          wrapper.parentNode.replaceChild(restoredBtn, wrapper);
          restoredBtn.addEventListener('click', arguments.callee);
        });
    });
  }
});
</script>
<style>
/* Responsive stacking for event action buttons */
@media (max-width: 600px) {
  .event-actions {display:flex; flex-direction:column; align-items:stretch; gap:0.5rem;}
  .event-actions a.btn,
  .event-actions form .btn {width:100%;}
  .event-actions form {margin:0;}
}
</style>
{% endblock %}
