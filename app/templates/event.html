{% extends 'base.html' %}
{% block title %}Event - {{ event.name }}{% endblock %}
{% block content %}
<div class="row">
  <div class="col s12">
    <div id="event-root" data-event-id="{{ event.id }}" style="display:none;"></div>
    <h4>{{ event.name }}</h4>
    <p>
      {% if event.date %}<b>Date:</b> {{ event.date }} |{% endif %}
      {% if event.budget_amount %}<b>Budget:</b> {{ event.budget_amount }} {{ event.budget_currency }}{% endif %}
    </p>
    {% set is_admin = (event.admin_user_id == current_user.id) %}
    {% if is_admin %}
      <a class="btn modal-trigger" href="#edit-event-modal"><i class="material-icons left">edit</i>Edit Event</a>
      <form method="post" action="{{ url_for('events.delete_event', event_id=event.id) }}" style="display:inline;" onsubmit="return confirm('Delete event? This cannot be undone');">
        <button type="submit" class="btn red"><i class="material-icons left">delete</i>Delete Event</button>
      </form>
    {% else %}
      <form method="post" action="{{ url_for('events.leave_event', event_id=event.id) }}" style="display:inline;" onsubmit="return confirm('Leave this event?');">
        <button type="submit" class="btn orange"><i class="material-icons left">exit_to_app</i>Leave Event</button>
      </form>
    {% endif %}
  </div>
</div>

<div class="row">
  <div class="col s12 m6">
    <h5>Participants</h5>
    <ul class="collection" id="participants-list">
      {% for p in participants %}
      <li class="collection-item">
        <span class="title"><b>{{ p.user.nickname }}</b></span>
        {% if p.status == 'pending' %}<span class="new badge orange" data-badge-caption="Pending"></span>{% endif %}
        {% if p.is_admin %}<span class="new badge teal" data-badge-caption="Admin"></span>{% endif %}
  {% if p.status == 'accepted' %}
  <a href="#" class="secondary-content participant-wishlist-link" data-user-id="{{ p.user.id }}" data-nickname="{{ p.user.nickname }}"><i class="material-icons">list</i></a>
  {% endif %}
      </li>
      {% endfor %}
    </ul>

    <div class="card" style="padding:1rem;">
      <h6>Invite User</h6>
      <form method="post" action="{{ url_for('events.invite_user', event_id=event.id) }}">
        <div class="input-field">
          <input name="nickname" id="invite-nickname" type="text" required>
          <label for="invite-nickname">User Nickname</label>
        </div>
        <button type="submit" class="btn teal"><i class="material-icons left">person_add</i>Invite</button>
      </form>
    </div>
  </div>

  <div class="col s12 m6">
    <h5 id="participant-wishlist-title">Participant Wishlist</h5>
    <ul class="collection" id="participant-wishlist"></ul>
  </div>
</div>

<div class="row">
  <div class="col s12">
    <h5>My Wishlist (Event Context)</h5>
    <!-- Reuse existing wishlist modal trigger but make button full width -->
    <a class="btn modal-trigger teal" style="width:100%;" href="#add-item-modal"><i class="material-icons left">add</i>Add Item</a>
    <ul class="collection" id="my-wishlist-items"></ul>
  </div>
</div>

<!-- Add/Edit Item Modal (copied from wishlist.html) -->
<div id="add-item-modal" class="modal">
  <div class="modal-content">
    <h5 id="modal-title">Add Item</h5>
    <form id="item-form">
      <input type="hidden" id="item-id">
      <div class="input-field">
        <input id="item-name" name="name" type="text" required>
        <label for="item-name">Name</label>
      </div>
      <div class="input-field">
        <input id="item-price" name="price" type="number" step="0.01">
        <label for="item-price">Price</label>
      </div>
      <div class="input-field">
        <input id="item-event" name="event" type="text" value="{{ event.name }}">
        <label for="item-event">Event (tag)</label>
      </div>
      <div class="input-field">
        <input id="item-link" name="link" type="url">
        <label for="item-link">Link (URL)</label>
      </div>
      <div class="input-field">
        <textarea id="item-details" name="details" class="materialize-textarea"></textarea>
        <label for="item-details">Details</label>
      </div>
      <button class="btn teal" type="submit">Save</button>
    </form>
  </div>
</div>

<!-- Edit Event Modal -->
<div id="edit-event-modal" class="modal">
  <div class="modal-content">
    <h5>Edit Event</h5>
    <form method="post" action="{{ url_for('events.edit_event', event_id=event.id) }}">
      <div class="input-field">
        <input name="name" id="edit-event-name" type="text" value="{{ event.name }}" required>
        <label for="edit-event-name" class="active">Event Name</label>
      </div>
      <div class="input-field">
        <input name="date" id="edit-event-date" type="date" value="{{ event.date }}">
        <label for="edit-event-date" class="active">Date</label>
      </div>
      <div class="input-field">
        <input name="budget_amount" id="edit-event-budget" type="number" step="0.01" value="{{ event.budget_amount }}">
        <label for="edit-event-budget" class="active">Budget Amount</label>
      </div>
      <div class="input-field">
        <select name="budget_currency" id="edit-event-currency">
          <option value="PLN" {% if event.budget_currency=='PLN' %}selected{% endif %}>PLN</option>
          <option value="EUR" {% if event.budget_currency=='EUR' %}selected{% endif %}>EUR</option>
          <option value="USD" {% if event.budget_currency=='USD' %}selected{% endif %}>USD</option>
        </select>
        <label for="edit-event-currency">Currency</label>
      </div>
      <button type="submit" class="btn teal">Save</button>
    </form>
  </div>
</div>
{% endblock %}
{% block scripts %}
<script>
M.AutoInit();

// Acquire event id from hidden root element to avoid inline JS templating issues
const EVENT_ID = parseInt(document.getElementById('event-root').getAttribute('data-event-id'), 10);

function loadMyWishlist() {
  fetch('/wishlist/')
    .then(res => res.json())
    .then(items => {
      const list = document.getElementById('my-wishlist-items');
      list.innerHTML='';
      items.forEach(item => {
        const li=document.createElement('li');
        li.className='collection-item avatar';
        li.innerHTML=`<img src="/static/default_bullet.png" class="circle">
          <span class="title"><b>${item.name}</b></span>
          <p>Price: ${item.price || '-'} | Event: ${item.event || '-'}<br>${item.details || ''}</p>
          <a href="${item.link || '#'}" target="_blank">${item.link? 'Link' : ''}</a>
          <a href="#" onclick="editItem(${item.id}); return false;" class="secondary-content"><i class="material-icons">edit</i></a>
          <a href="#" onclick="deleteItem(${item.id}); return false;" class="secondary-content" style="margin-right:2.5rem"><i class="material-icons red-text">delete</i></a>`;
        list.appendChild(li);
      });
    });
}

function loadParticipantWishlist(eventId, userId, nickname) {
  fetch(`/events/${eventId}/participant/${userId}/wishlist`)
    .then(res => res.json())
    .then(items => {
      document.getElementById('participant-wishlist-title').textContent = nickname + "'s Wishlist";
      const list = document.getElementById('participant-wishlist');
      list.innerHTML='';
      items.forEach(item => {
        const li=document.createElement('li');
        li.className='collection-item avatar';
        li.innerHTML=`<img src="/static/default_bullet.png" class="circle">
          <span class="title"><b>${item.name}</b></span>
          <p>Price: ${item.price || '-'} | Event: ${item.event || '-'}<br>${item.details || ''}</p>
          <a href="${item.link || '#'}" target="_blank">${item.link? 'Link' : ''}</a>`;
        list.appendChild(li);
      });
    });
}

function editItem(id) {
  fetch(`/wishlist/` + id)
    .then(res => res.json())
    .then(item => {
      document.getElementById('modal-title').textContent='Edit Item';
      document.getElementById('item-id').value=item.id;
      document.getElementById('item-name').value=item.name;
      document.getElementById('item-price').value=item.price;
      document.getElementById('item-event').value=item.event;
      document.getElementById('item-link').value=item.link;
      document.getElementById('item-details').value=item.details;
      M.updateTextFields();
      const modal=M.Modal.getInstance(document.getElementById('add-item-modal'));
      modal.open();
    });
}

function deleteItem(id) {
  if(confirm('Delete this item?')) {
    fetch(`/wishlist/${id}`, {method:'DELETE'})
      .then(r=>r.json())
      .then(()=>loadMyWishlist());
  }
}

document.getElementById('item-form').onsubmit=function(e){
  e.preventDefault();
  const id=document.getElementById('item-id').value;
  const formData=new FormData(this);
  const method=id? 'PUT':'POST';
  const url='/wishlist/' + (id? id:'');
  fetch(url, {method:method, body:JSON.stringify(Object.fromEntries(formData)), headers:{'Content-Type':'application/json'}})
    .then(r=>r.json())
    .then(()=>{loadMyWishlist(); const modal=M.Modal.getInstance(document.getElementById('add-item-modal')); modal.close(); this.reset();});
};

document.addEventListener('DOMContentLoaded', function() {
  loadMyWishlist();
  // Attach participant wishlist handlers
  document.querySelectorAll('.participant-wishlist-link').forEach(function(el){
    el.addEventListener('click', function(e){
      e.preventDefault();
      const userId=this.getAttribute('data-user-id');
      const nickname=this.getAttribute('data-nickname');
  loadParticipantWishlist(EVENT_ID, userId, nickname);
    });
  });
});
</script>
{% endblock %}
